{"version":3,"file":"taquito-beacon-wallet.umd.js","sources":["../src/errors.ts","../src/version.ts","../src/taquito-beacon-wallet.ts"],"sourcesContent":["import { PermissionScope } from '@airgap/beacon-dapp';\nimport { PermissionDeniedError } from '@taquito/core';\n\n/**\n *  @category Error\n *  @description Error that indicates the Beacon wallet not being initialized\n */\nexport class BeaconWalletNotInitialized extends PermissionDeniedError {\n  constructor() {\n    super();\n    this.name = 'BeaconWalletNotInitialized';\n    this.message =\n      'BeaconWallet needs to be initialized by calling `await BeaconWallet.requestPermissions({network: {type: \"chosen_network\"}})` first.';\n  }\n}\n\n/**\n *  @category Error\n *  @description Error that indicates missing required persmission scopes\n */\nexport class MissingRequiredScopes extends PermissionDeniedError {\n  constructor(public readonly requiredScopes: PermissionScope[]) {\n    super();\n    this.name = 'MissingRequiredScopes';\n    this.message = `Required permissions scopes: ${requiredScopes.join(',')} were not granted.`;\n  }\n}\n","\n// IMPORTANT: THIS FILE IS AUTO GENERATED! DO NOT MANUALLY EDIT OR CHECKIN!\nexport const VERSION = {\n    \"commitHash\": \"a5b3c864e1537d0fe0a7f8f0b55989ef89311fa2\",\n    \"version\": \"17.3.0\"\n};\n","/**\n * @packageDocumentation\n * @module @taquito/beacon-wallet\n */\n\nimport {\n  DAppClient,\n  DAppClientOptions,\n  RequestPermissionInput,\n  PermissionScope,\n  getDAppClientInstance,\n  SigningType,\n} from '@airgap/beacon-dapp';\nimport { BeaconWalletNotInitialized, MissingRequiredScopes } from './errors';\nimport toBuffer from 'typedarray-to-buffer';\nimport {\n  createIncreasePaidStorageOperation,\n  createOriginationOperation,\n  createSetDelegateOperation,\n  createTransferOperation,\n  WalletDelegateParams,\n  WalletIncreasePaidStorageParams,\n  WalletOriginateParams,\n  WalletProvider,\n  WalletTransferParams,\n} from '@taquito/taquito';\nimport { buf2hex, hex2buf, mergebuf } from '@taquito/utils';\nimport { UnsupportedActionError } from '@taquito/core';\n\nexport { VERSION } from './version';\nexport { BeaconWalletNotInitialized, MissingRequiredScopes } from './errors';\n\nexport class BeaconWallet implements WalletProvider {\n  public client: DAppClient;\n\n  constructor(options: DAppClientOptions) {\n    this.client = getDAppClientInstance(options);\n  }\n\n  private validateRequiredScopesOrFail(\n    permissionScopes: PermissionScope[],\n    requiredScopes: PermissionScope[]\n  ) {\n    const mandatoryScope = new Set(requiredScopes);\n\n    for (const scope of permissionScopes) {\n      if (mandatoryScope.has(scope)) {\n        mandatoryScope.delete(scope);\n      }\n    }\n\n    if (mandatoryScope.size > 0) {\n      throw new MissingRequiredScopes(Array.from(mandatoryScope));\n    }\n  }\n\n  async requestPermissions(request?: RequestPermissionInput) {\n    await this.client.requestPermissions(request);\n  }\n\n  async getPKH() {\n    const account = await this.client.getActiveAccount();\n    if (!account) {\n      throw new BeaconWalletNotInitialized();\n    }\n    return account.address;\n  }\n\n  async mapTransferParamsToWalletParams(params: () => Promise<WalletTransferParams>) {\n    let walletParams: WalletTransferParams;\n    await this.client.showPrepare();\n    try {\n      walletParams = await params();\n    } catch (err) {\n      await this.client.hideUI();\n      throw err;\n    }\n    return this.removeDefaultParams(\n      walletParams,\n      await createTransferOperation(this.formatParameters(walletParams))\n    );\n  }\n\n  async mapIncreasePaidStorageWalletParams(params: () => Promise<WalletIncreasePaidStorageParams>) {\n    let walletParams: WalletIncreasePaidStorageParams;\n    await this.client.showPrepare();\n    try {\n      walletParams = await params();\n    } catch (err) {\n      await this.client.hideUI();\n      throw err;\n    }\n    return this.removeDefaultParams(\n      walletParams,\n      await createIncreasePaidStorageOperation(this.formatParameters(walletParams))\n    );\n  }\n\n  async mapOriginateParamsToWalletParams(params: () => Promise<WalletOriginateParams>) {\n    let walletParams: WalletOriginateParams;\n    await this.client.showPrepare();\n    try {\n      walletParams = await params();\n    } catch (err) {\n      await this.client.hideUI();\n      throw err;\n    }\n    return this.removeDefaultParams(\n      walletParams,\n      await createOriginationOperation(this.formatParameters(walletParams))\n    );\n  }\n\n  async mapDelegateParamsToWalletParams(params: () => Promise<WalletDelegateParams>) {\n    let walletParams: WalletDelegateParams;\n    await this.client.showPrepare();\n    try {\n      walletParams = await params();\n    } catch (err) {\n      await this.client.hideUI();\n      throw err;\n    }\n    return this.removeDefaultParams(\n      walletParams,\n      await createSetDelegateOperation(this.formatParameters(walletParams))\n    );\n  }\n\n  formatParameters(params: any) {\n    if (params.fee) {\n      params.fee = params.fee.toString();\n    }\n    if (params.storageLimit) {\n      params.storageLimit = params.storageLimit.toString();\n    }\n    if (params.gasLimit) {\n      params.gasLimit = params.gasLimit.toString();\n    }\n    return params;\n  }\n\n  removeDefaultParams(\n    params: WalletTransferParams | WalletOriginateParams | WalletDelegateParams,\n    operatedParams: any\n  ) {\n    // If fee, storageLimit or gasLimit is undefined by user\n    // in case of beacon wallet, dont override it by\n    // defaults.\n    if (!params.fee) {\n      delete operatedParams.fee;\n    }\n    if (!params.storageLimit) {\n      delete operatedParams.storage_limit;\n    }\n    if (!params.gasLimit) {\n      delete operatedParams.gas_limit;\n    }\n    return operatedParams;\n  }\n\n  async sendOperations(params: any[]) {\n    const account = await this.client.getActiveAccount();\n    if (!account) {\n      throw new BeaconWalletNotInitialized();\n    }\n    const permissions = account.scopes;\n    this.validateRequiredScopesOrFail(permissions, [PermissionScope.OPERATION_REQUEST]);\n\n    const { transactionHash } = await this.client.requestOperation({ operationDetails: params });\n    return transactionHash;\n  }\n\n  /**\n   *\n   * @description Removes all beacon values from the storage. After using this method, this instance is no longer usable.\n   * You will have to instantiate a new BeaconWallet.\n   */\n  async disconnect() {\n    await this.client.destroy();\n  }\n\n  /**\n   *\n   * @description This method removes the active account from local storage by setting it to undefined.\n   */\n  async clearActiveAccount() {\n    await this.client.setActiveAccount();\n  }\n\n  async sign(bytes: string, watermark?: Uint8Array) {\n    let bb = hex2buf(bytes);\n    if (typeof watermark !== 'undefined') {\n      bb = mergebuf(watermark, bb);\n    }\n    const watermarkedBytes = buf2hex(toBuffer(bb));\n    const signingType = this.getSigningType(watermark);\n    if (signingType !== SigningType.OPERATION) {\n      throw new UnsupportedActionError(\n        `Taquito Beacon Wallet currently only supports signing operations, not ${signingType}`\n      );\n    }\n    const { signature } = await this.client.requestSignPayload({\n      payload: watermarkedBytes,\n      signingType,\n    });\n    return signature;\n  }\n\n  private getSigningType(watermark?: Uint8Array) {\n    if (!watermark || watermark.length === 0) {\n      return SigningType.RAW;\n    }\n    if (watermark.length === 1) {\n      if (watermark[0] === 5) {\n        return SigningType.MICHELINE;\n      }\n      if (watermark[0] === 3) {\n        return SigningType.OPERATION;\n      }\n    }\n    throw new Error(`Invalid watermark ${JSON.stringify(watermark)}`);\n  }\n\n  async getPK() {\n    const account = await this.client.getActiveAccount();\n    if (!account) {\n      throw new BeaconWalletNotInitialized();\n    }\n    return account?.publicKey;\n  }\n}\n"],"names":["PermissionDeniedError","getDAppClientInstance","createTransferOperation","createIncreasePaidStorageOperation","createOriginationOperation","createSetDelegateOperation","PermissionScope","hex2buf","mergebuf","buf2hex","toBuffer","SigningType","UnsupportedActionError"],"mappings":"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"}